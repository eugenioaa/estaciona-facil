{# templates/avaliacao_estacionamento.html #}
{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avaliações de Estacionamento</title>
  <link rel="stylesheet" href="{% static 'styles.css' %}" />
</head>
<body>
  <header class="cabecalho">
    <div class="logo">
      <img src="https://img.freepik.com/vetores-premium/pin-de-vetor-de-modelo-de-logotipo-de-estacionamento-de-carros_316488-5081.jpg" alt="Logo do Projeto" />
    </div>
    <nav class="menu">
      <button onclick="location.href='{% url 'tela_principal' %}'">Início</button>
      <button onclick="location.href='{% url 'sistema_avaliacao' %}'" class="ativo">Avaliação</button>
      <button onclick="location.href='{% url 'register' %}'">Criar Conta</button>
    </nav>
  </header>

  <h1>Sistema de Avaliações de Estacionamentos</h1>

  {# 1) Seletor de estacionamento #}
  <section class="selecionar-estacionamento caixa">
    <form method="get">
      <label for="estac_id">Escolha o estacionamento:</label>
      <select name="estac_id" id="estac_id" onchange="this.form.submit()">
        <option value="">-- Selecione --</option>
        {% for est in estacionamentos %}
          <option value="{{ est.id }}" {% if est.id|stringformat:"s" == request.GET.estac_id %}selected{% endif %}>
            {{ est.nome }}
          </option>
        {% endfor %}
      </select>
    </form>
  </section>

  {# 2) Se nenhum escolhido ainda, mostra mensagem #}
  {% if not estacionamento %}
    <p class="caixa">Selecione um estacionamento acima para ver detalhes e avaliações.</p>
  {% else %}

    {# 3) Informações do estacionamento selecionado #}
    <section class="estacionamento-info caixa">
      {% if estacionamento.imagem_url %}
        <img src="{{ estacionamento.imagem_url }}" alt="Foto de {{ estacionamento.nome }}" class="estacionamento-img">
      {% endif %}
      <div>
        <h2>{{ estacionamento.nome }}</h2>
        <p>Endereço: {{ estacionamento.endereco }}</p>
        <p>Disponibilidade: {{ estacionamento.get_disponibilidade_display }}</p>
        <p>Horário de Funcionamento: {{ estacionamento.horario_abertura|time:"H:i" }} às {{ estacionamento.horario_fechamento|time:"H:i" }}</p>
      </div>
    </section>

    {# 4) Avaliação média (passada no contexto pela view) #}
    <section class="avaliacoes caixa">
      <h3>Avaliação Média</h3>
      <p>Segurança: <span class="estrelas">{{ media_seguranca }}</span></p>
      <p>Praticidade: <span class="estrelas">{{ media_praticidade }}</span></p>
      <p>Preço: <span class="estrelas">{{ media_preco }}</span></p>
      <p>Disponibilidade: <span class="estrelas">{{ media_disponibilidade }}</span></p>
    </section>

    {# 5) Lista de avaliações individuais #}
    <section class="avaliacoes caixa">
      <h2>Avaliações dos Usuários</h2>
      {% for avaliacao in avaliacoes %}
        <div class="avaliacao" style="border-bottom:1px solid #ccc; margin-bottom:1em; padding-bottom:1em;">
          <strong>{{ avaliacao.usuario.username }}</strong> —
          <span>{{ avaliacao.estacionamento.nome }}</span> —
          <span class="estrelas">
            {% with media=avaliacao.media_avaliacao %}
              {% for i in "12345" %}
                {% if forloop.counter <= media %}★{% else %}☆{% endif %}
              {% endfor %}
              <span style="font-size:0.9em; color:#888;">({{ media }})</span>
            {% endwith %}
          </span><br>
          {{ avaliacao.comentario }}
        </div>
      {% empty %}
        <p>Nenhuma avaliação ainda. Seja o primeiro a avaliar!</p>
      {% endfor %}
    </section>

    {# 6) Formulário para deixar nova avaliação #}
    <section class="formulario caixa">
      <h2>Deixe sua Avaliação</h2>
      <form method="post">
        {% csrf_token %}
        {{ avaliacao_form.non_field_errors }}

        <input type="hidden" name="estacionamento" value="{{ estacionamento.id }}">

        <div class="field">
          {{ avaliacao_form.nota_seguranca.label_tag }}<br>
          {{ avaliacao_form.nota_seguranca }}
          {{ avaliacao_form.nota_seguranca.errors }}
        </div>
        <div class="field">
          {{ avaliacao_form.nota_praticidade.label_tag }}<br>
          {{ avaliacao_form.nota_praticidade }}
          {{ avaliacao_form.nota_praticidade.errors }}
        </div>
        <div class="field">
          {{ avaliacao_form.nota_preco.label_tag }}<br>
          {{ avaliacao_form.nota_preco }}
          {{ avaliacao_form.nota_preco.errors }}
        </div>
        <div class="field">
          {{ avaliacao_form.nota_disponibilidade.label_tag }}<br>
          {{ avaliacao_form.nota_disponibilidade }}
          {{ avaliacao_form.nota_disponibilidade.errors }}
        </div>
        <div class="field">
          {{ avaliacao_form.comentario.label_tag }}<br>
          {{ avaliacao_form.comentario }}
          {{ avaliacao_form.comentario.errors }}
        </div>

        <button type="submit" class="btn">Enviar Avaliação</button>
      </form>
    </section>
  {% endif %}
</body>
</html>
