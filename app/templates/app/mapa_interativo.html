{% extends 'app/base.html' %}
{% load static %}

{% block title %}Mapa Interativo - EstacionaFácil{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'mapa_interativo.css' %}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}

{% block content %}
<div class="container">
    <section class="filter-section">
        <button class="filter-button">
            Filtros <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="filter-tag">
            Value <i class="fa-solid fa-xmark"></i>
        </div>
    </section>

    <section class="map-container">
        <div id="map"></div>
    </section>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- CORREÇÃO: Usamos a nova variável 'estacionamentos_list' -->
    {{ estacionamentos_list|json_script:"estacionamentos-data" }}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. INICIALIZAÇÃO DO MAPA ---
        const map = L.map('map').setView([-22.976, -43.227], 14); // Centralizado na Gávea
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- 2. LEITURA DOS DADOS (AGORA SIMPLIFICADA) ---
        const dataElement = document.getElementById('estacionamentos-data');
        
        // JSON.parse agora vai funcionar corretamente e retornar um array
        const estacionamentos = JSON.parse(dataElement.textContent); 

        if (!estacionamentos || estacionamentos.length === 0) {
            console.warn("AVISO: A lista de estacionamentos está vazia.");
            return;
        }
        
        // A etapa de .map() não é mais necessária, pois os dados já estão no formato certo.

        // --- 3. ADICIONA MARCADORES NO MAPA ---
        let markersAdded = 0;
        estacionamentos.forEach(est => {
            if (est.latitude && est.longitude) {
                const marker = L.marker([est.latitude, est.longitude]).addTo(map);
                marker.bindPopup(`<b>${est.nome}</b>`);
                markersAdded++;
            }
        });
        
        console.log(`Processo concluído. ${markersAdded} marcadores foram adicionados ao mapa.`);
    });
    </script>
{% endblock %}