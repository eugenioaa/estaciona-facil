{% extends 'app/base.html' %}
{% load static %}

{% block title %}Mapa Interativo - EstacionaF√°cil{% endblock %}

{% block styles %}
    <!-- Carrega apenas os estilos espec√≠ficos para a p√°gina do mapa -->
    <link rel="stylesheet" href="{% static 'mapa_interativo.css' %}" />
    
    <!-- Links para o Leaflet (mapa) e Font Awesome (√≠cones) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

{% endblock %}

{% block content %}
<div class="container">
    <section class="filter-section">
        <button class="filter-button">
            Filtros <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="filter-tag">
            Value <i class="fa-solid fa-xmark"></i>
        </div>
    </section>

    <section class="map-container">
        <div id="map"></div>
    </section>

    <!-- A sec√ß√£o de detalhes agora est√° vazia e ser√° preenchida pelo JavaScript -->
    <section id="details-section" class="details-section" style="display: none;">
        <div class="location-details-card">
            <div id="details-image-placeholder" class="image-placeholder">
                <i class="fa-regular fa-image"></i>
            </div>
            <div class="location-info">
                <h3 id="details-nome"></h3>
                <p id="details-endereco"></p>
            </div>
        </div>
        
        <div id="details-reviews" class="reviews-container">
            <!-- As avalia√ß√µes ser√£o inseridas aqui pelo JavaScript -->
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
    <!-- Scripts no final do body -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {{ estacionamentos_json|json_script:"estacionamentos-data" }}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. INICIALIZA√á√ÉO DO MAPA ---
        const map = L.map('map').setView([-22.9845, -43.2048], 14); // Centralizado em Ipanema
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- 2. LEITURA DOS DADOS ---
        const dataElement = document.getElementById('estacionamentos-data');
        const estacionamentosData = dataElement ? JSON.parse(dataElement.textContent) : [];
        const estacionamentos = estacionamentosData.map(item => ({ id: item.pk, ...item.fields }));

        // --- 3. ELEMENTOS DO DOM ---
        const detailsSection = document.getElementById('details-section');
        const detailsNome = document.getElementById('details-nome');
        const detailsEndereco = document.getElementById('details-endereco');
        const detailsImagePlaceholder = document.getElementById('details-image-placeholder');
        const detailsReviewsContainer = document.getElementById('details-reviews');

        // --- 4. FUN√á√ÉO PARA ATUALIZAR OS DETALHES ---
        function showDetails(estacionamento) {
            // Atualiza o card de informa√ß√µes b√°sicas
            detailsNome.textContent = estacionamento.nome;
            detailsEndereco.textContent = `üìç ${estacionamento.endereco}`;
            
            // Limpa e atualiza a imagem (ou mostra o √≠cone)
            detailsImagePlaceholder.innerHTML = estacionamento.imagem_url 
                ? `<img src="${estacionamento.imagem_url}" alt="Foto de ${estacionamento.nome}" style="width:100%; height:100%; object-fit:cover;">`
                : '<i class="fa-regular fa-image"></i>';

            // Limpa as avalia√ß√µes antigas
            detailsReviewsContainer.innerHTML = '';

            // Adiciona duas avalia√ß√µes de exemplo (no futuro, viriam do banco de dados)
            for (let i = 0; i < 2; i++) {
                const reviewCard = document.createElement('article');
                reviewCard.className = 'review-card';
                reviewCard.innerHTML = `
                    <div class="review-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>
                    <h4 class="review-title">√ìtima localiza√ß√£o!</h4>
                    <p class="review-body">F√°cil de encontrar e com muitas vagas dispon√≠veis quando fui.</p>
                    <div class="reviewer-info">
                        <img src="https://i.pravatar.cc/30?u=${i}" alt="Avatar">
                        <span>Usu√°rio ${i + 1}<br><small>Hoje</small></span>
                    </div>
                `;
                detailsReviewsContainer.appendChild(reviewCard);
            }

            // Mostra a sec√ß√£o de detalhes
            detailsSection.style.display = 'flex';
        }

        // --- 5. ADICIONA MARCADORES NO MAPA ---
        estacionamentos.forEach(est => {
            if (est.latitude && est.longitude) {
                const marker = L.marker([est.latitude, est.longitude]).addTo(map);
                marker.bindPopup(`<b>${est.nome}</b>`);
                
                // Adiciona o evento de clique para mostrar os detalhes
                marker.on('click', () => {
                    showDetails(est);
                });
            }
        });
    });
    </script>
{% endblock %}